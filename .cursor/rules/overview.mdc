---
description:
globs:
alwaysApply: false
---
# MCP Server Design (Cloudflare Template: remote-mcp-github-oauth)

**RevisionÂ 0.2Â â€“Â 3â€¯Julyâ€¯2025**

---

## 1Â Â· Template Foundation

We fork `cloudflare/ai/demos/remote-mcp-github-oauth` as the scaffold. The demo already provides:

* **Worker entryâ€‘point** (`src/index.ts`) with `handleMcpRequest` router.
* **GitHubÂ OAuth** (PKCE + state in KV) protecting `/mcp`.
* **RemoteÂ MCP dispatcher** (`remoteMcpFetch`) that forwards authorised requests.
* **Bindings** inÂ `wrangler.jsonc` for KV, D1, R2 & AI Gateway.

Our job is to extendâ€”not replaceâ€”this template so it powers ASIâ€™s full multiâ€‘tool MCP gateway.

---

## 2Â Â· DeltaÂ from Template

| Â AreaÂ              | TemplateÂ Behaviour   | ASIÂ MCP Modifications                                                                                      |
| ------------------ | -------------------- | ---------------------------------------------------------------------------------------------------------- |
| **OAuthÂ Provider** | GitHubÂ only          | Switch default to **Microsoft AzureÂ AD** for endâ€‘user entry. Keep GitHub via feature flag for engineering. |
| **Tool Auth**      | None                 | Add perâ€‘tool auth adapters (OAuthÂ or API key) stored in D1Â table `tool_credentials`.                       |
| **Config**         | Hardâ€‘coded constants | Load external `mcp.config.ts` with toggles, rateâ€‘limits & tool manifests.                                  |
| **State**          | Session in KV        | Persist OAuth & tool tokens in **D1** so creds survive redeploys.                                          |
| **Testing**        | N/A                  | Add Vitest + `@robertdouglass/mcpâ€‘tester` with inâ€‘memory client and liveâ€‘captureâ†’mock workflow.            |

---

## 3Â Â· Project Layout (modular services âœ subâ€‘folders)

Every SaaS providerâ€”PandaDoc, HubSpot,â€¯Xero,â€¯NetSuite,â€¯Autotaskâ€”will ship **multiple MCP tools**. To keep the codebase discoverable, we promote each provider to its own directory with a local `index.ts` that reâ€‘exports the individual tools.

```
/ src
â”‚  index.ts                  # Worker bootstrap (router + MCPServer)
â”‚  mcpServer.ts              # DurableÂ Object subclass + listTools()
â”‚
â”œâ”€ config/
â”‚   mcp.defaults.ts          # Feature flags / toggles (committed)
â”‚   mcp.secrets.schema.ts    # zod schema â€“ compileâ€‘time only
â”‚   loader.ts                # merge(defaults, env) â†’ typed config
â”‚
â”œâ”€ auth/
â”‚   microsoft.ts             # AzureÂ AD entry auth
â”‚   tool-auth.ts             # Generic perâ€‘tool resolver
â”‚   withOAuth.ts             # HOF wrapper (see Â§5.5)
â”‚
â”œâ”€ tools/                    # One folder per provider â†“â†“â†“
â”‚   â”œâ”€ pandadoc/
â”‚   â”‚    index.ts            # exports sendDocument, getStatus â€¦
â”‚   â”‚    sendDocument.ts
â”‚   â”‚    getStatus.ts
â”‚   â”‚    listTemplates.ts
â”‚   â”‚    _client.ts          # lowâ€‘level REST wrapper (shared)
â”‚   â”‚
â”‚   â”œâ”€ hubspot/
â”‚   â”‚    index.ts
â”‚   â”‚    contacts/
â”‚   â”‚       search.ts
â”‚   â”‚       create.ts
â”‚   â”‚    deals/
â”‚   â”‚       list.ts
â”‚   â”‚    _client.ts
â”‚   â”‚
â”‚   â”œâ”€ xero/
â”‚   â”‚    index.ts
â”‚   â”‚    invoices/create.ts
â”‚   â”‚    contacts/list.ts
â”‚   â”‚    _client.ts
â”‚   â”‚
â”‚   â”œâ”€ netsuite/
â”‚   â”‚    index.ts
â”‚   â”‚    salesOrders/create.ts
â”‚   â”‚    customers/search.ts
â”‚   â”‚    _client.ts
â”‚   â”‚
â”‚   â””â”€ autotask/
â”‚        index.ts
â”‚        tickets/create.ts
â”‚        tickets/update.ts
â”‚        _client.ts
â”‚
â”œâ”€ middleware/
â”‚   rate-limit.ts            # Worker RateÂ Limiting API helper
â”‚   sentry-span.ts           # wrapTool() util (Â§11.1.1)
â”‚
â”œâ”€ types/
â”‚   index.ts                 # shared enums, aliases
â”‚
â””â”€ tests/
    setup/                   # vitest.setup.ts, mock oauth
    unit/                    # logicâ€‘only tests
    integration/             # RECORD=1 â†’ cassettes
    __recordings__/

wrangler.jsonc
```

### 3.1Â Import ergonomics

* **Public barrel files** (`tools/<provider>/index.ts`) reâ€‘export all MCP toolÂ functions. `src/tools/index.ts` simply reâ€‘imports these, registers them via `server.registerTool`, and respects the perâ€‘tool `enabled` flags fromÂ Â§4.
* **Path alias** update (in `tsconfig.json`):

```jsonc
"paths": {
  "@tools/*": ["src/tools/*"],
  "@tools-pandadoc/*": ["src/tools/pandadoc/*"],
  "@tools-hubspot/*": ["src/tools/hubspot/*"]
}
```

### 3.2Â Why this structure?

| Goal                      | Layout win                                                                                   |
| ------------------------- | -------------------------------------------------------------------------------------------- |
| **Scalability**           | New PandaDoc tool â‡’ add a file under `tools/pandadoc/` & export itâ€”no global switchboard.    |
| **Singleâ€‘responsibility** | `_client.ts` files hold auth headers + lowâ€‘level REST; each tool focuses on business logic.  |
| **Selective shipping**    | Treeâ€‘shaking drops disabled providers/tools at buildâ€‘time if `config.tools.*.enabled=false`. |
| **Test isolation**        | Integration tests mirror directory structure (`tests/integration/pandadoc/send.spec.ts`).    |

> **Tip:** Add a lint rule (eslintâ€‘pluginâ€‘boundaries) to forbid crossâ€‘provider imports so HubSpot tools canâ€™t accidentally reference PandaDoc code.

---

## 4Â Â· Configuration & Secret HandlingÂ Â· Configuration & Secret Handling

Managing config in a Cloudflare Worker means juggling *runtimeÂ bindings* (from **wrangler.jsonc** / `wrangler secret`) with *compileâ€‘timeÂ types* (in **workerâ€‘configuration.d.ts**) and *developer ergonomics* (via **.dev.vars**). The table below shows where each concern lives:

| Concern                                                           | DevÂ file                    | Committed?           | ProdÂ source           | Notes                                      |
| ----------------------------------------------------------------- | --------------------------- | -------------------- | --------------------- | ------------------------------------------ |
| **Nonâ€‘secret toggles**(feature flags, rateâ€‘limits, enabledÂ tools) | `config/mcp.defaults.ts`    | **Yes**              | Bundled code          | Safe to commit; no credentials.            |
| **Secret values**(client IDs, client secrets, API keys)           | `.dev.vars`                 | **No** (gitâ€‘ignored) | `wrangler secret put` | Loaded into `env` at runtime.              |
| **Type definitions**for *Env* & config                            | `workerâ€‘configuration.d.ts` | **Yes**              | â€”â€”                    | Ensures `env` & config are stronglyâ€‘typed. |
| **InfraÂ bindings**(KV, D1, R2, vars)                              | `wrangler.jsonc`            | **Yes**              | Cloudflare Dashboard  | SeparateÂ \[env] sections per stage.        |

### 4.1Â Directory Layout

```
config/
â”œâ”€ mcp.defaults.ts      # Nonâ€‘secret baseline (committed)
â”œâ”€ mcp.secrets.schema.ts# zod schema for secrets (compile only)
â””â”€ config.example.env   # Example of .dev.vars
```

`mcp.defaults.ts` keeps only safe values:

```ts
export const defaults = {
  oauth: {
    provider: "microsoft",
    scopes: ["openid", "profile", "offline_access"],
    redirectUri: "/.auth/callback"
  },
  /**
   * Perâ€‘provider and perâ€‘tool toggles
   * ------------------------------------------------------
   * `enabled`      â€“ master on/off switch for the whole SaaS integration.
   * `operations`   â€“ fineâ€‘grained flags for individual MCP tools that live inside that provider.
   *                  Omit the key to inherit the parent providerâ€™s `enabled` state.
   */
  tools: {
    pandadoc: {
      enabled: true,                // turn *all* PandaDoc tools on/off here
      oauth: true,
      rateLimit: { max: 30, period: "1m" },
      operations: {
        sendDocument:  { enabled: true,  rateLimit: { max: 20, period: "1m" } },
        getStatus:     { enabled: true },
        listTemplates: { enabled: false }  // disabled until legal signâ€‘off
      }
    },
    // â€¦other providers (hubspot, xero, etc) follow the same shapeâ€¦
  },
  worker: { logLevel: "info" }
} satisfies Omit<MCPConfig, "oauth" | "tools"> & Partial<MCPConfig>;

```

### 4.2Â Secret Injection Workflow

1. **LocalÂ dev** â€“ create `.dev.vars` (gitâ€‘ignored) with:

   ```env
   MICROSOFT_CLIENT_ID=...
   MICROSOFT_CLIENT_SECRET=...
   PANDADOC_CLIENT_ID=...
   PANDADOC_CLIENT_SECRET=...
   ```

   `wrangler dev` autoâ€‘loads this file.
2. **Staging / Prod** â€“ run `wrangler secret put MICROSOFT_CLIENT_ID`, etc. **Never** commit real secrets.
3. **Code** reads secrets via the `env`:Â 

   ```ts
   export function loadConfig(env: Env): MCPConfig {
     return {
       ...defaults,
       oauth: {
         ...defaults.oauth,
         clientId: env.MICROSOFT_CLIENT_ID,
         tenantId: env.MICROSOFT_TENANT_ID,
       },
       tools: {
         ...defaults.tools,
         pandadoc: {
           ...defaults.tools.pandadoc,
           clientId: env.PANDADOC_CLIENT_ID,
           clientSecret: env.PANDADOC_CLIENT_SECRET,
         }
       }
     };
   }
   ```

### 4.3Â Strong Typing (workerâ€‘configuration.d.ts)

```ts
export interface Env {
  // Secrets (injected)
  MICROSOFT_CLIENT_ID: string;
  MICROSOFT_CLIENT_SECRET: string;
  PANDADOC_CLIENT_ID: string;
  PANDADOC_CLIENT_SECRET: string;
  // Bindings
  CONFIG_KV: KVNamespace;
  MCP_DB: D1Database;
}
```

TypeScript & VSÂ Code now surface autocompletion + compiler errors if config fields are missing.

### 4.4Â wrangler.jsonc Snippet

```jsonc
{
  "name": "asi-mcp",
  "compatibility_date": "2025-07-03",
  "kv_namespaces": [
    { "binding": "CONFIG_KV", "id": "â€¦", "preview_id": "â€¦" }
  ],
  "d1_databases": [
    { "binding": "MCP_DB", "database_name": "asi-mcp-db", "database_id": "â€¦" }
  ],
  "vars": {
    // Nonâ€‘secret, stageâ€‘agnostic flags
    "TOOL_PANDADOC_ENABLED": "true"
  },
  "env": {
    "production": {
      "vars": { "LOG_LEVEL": "error" }
    },
    "staging": {
      "vars": { "LOG_LEVEL": "debug" }
    }
  }
}
```

The **vars** property is *public* (committed); secrets come from `wrangler secret`.

### 4.5Â tsconfig.json Helpers

```jsonc
{
  "compilerOptions": {
    "baseUrl": "./src",
    "paths": {
      "@config/*": ["../config/*"],
      "@tools/*": ["tools/*"]
    },
    "types": ["./worker-configuration.d.ts"]
  }
}
```

Path aliases keep imports tidy; adding `worker-configuration.d.ts` to `types` ensures `Env` is global.

### 4.6Â Commit Map & Git Hygiene

| File / Pattern              | Committed | Reason                                 |
| --------------------------- | --------- | -------------------------------------- |
| `config/mcp.defaults.ts`    | âœ…         | Nonâ€‘secret; documents feature flags.   |
| `config.example.env`        | âœ…         | Shows required envÂ vars for newcomers. |
| `.dev.vars`                 | ğŸš«        | Developerâ€‘specific secrets.            |
| `config/*.secret*.ts`       | ğŸš«        | Block via `.gitignore` glob.           |
| `wrangler.jsonc`            | âœ…         | Infra spec; no secrets.                |
| `worker-configuration.d.ts` | âœ…         | Types only.                            |

> **Tip:** Enforce the above with a preâ€‘commit hook (`lintâ€‘staged`) that aborts if forbidden envÂ keys appear in tracked files.

---

## 5Â Â· AuthenticationÂ &Â Perâ€‘Tool OAuth Flow

### 5.1Â Edge Session (MicrosoftÂ OAuth)

The public `/mcp` endpoint is still fronted by Microsoftâ€¯AzureÂ AD (PKCE). Tokens are cached in \*\*D1Â \*\*\`\` and silently refreshed by a scheduled Worker.

### 5.2Â Tool Credential Store

| Store                            | Key Schema            | Value                               | TTL      |
| -------------------------------- | --------------------- | ----------------------------------- | -------- |
| \*\*D1Â \*\*\`\`                  | `{userId}:{provider}` | JSON `{ access, refresh, expires }` | â€‘        |
| \*\*KVÂ \*\*\`\` (hotâ€‘path cache) | same as D1            | same                                | â‰¤Â 15â€¯min |

### 5.3Â HelperÂ `ensureTokenOrAuthUrl()`

```ts
// lib/auth.ts
export async function ensureTokenOrAuthUrl(env: Env, userId: string, provider: string) {
  const token = await env.TOOL_OAUTH_KV.get<{ access: string; expires: number }>(
    `${userId}:${provider}`,
    { type: "json" }
  );
  if (token?.access) return { access: token.access };
  // `/auth/<provider>` is mounted by createProvider() at startâ€‘up
  return { authUrl: new URL(`/auth/${provider}`, env.BASE_URL).toString() };
}
```

*If the token is absent* the tool returns `{ requiresAuth:true, authUrl }`Â â†’ the MCP client opens that URL and retries.

### 5.5Â Execution Patterns

We standardise the â€œcheck token / shortâ€‘circuitâ€ dance

#### 5.5.1Â Higherâ€‘Order WrapperÂ `withOAuth()` (explicit per tool)

```ts
// lib/withOAuth.ts
import { ensureTokenOrAuthUrl } from "./auth";
export const withOAuth = (provider: string, handler: Function) => async (ctx) => {
  const { access, authUrl } = await ensureTokenOrAuthUrl(ctx.env, ctx.props.user.id, provider);
  if (!access) return { requiresAuth: true, provider, authUrl, message: `Connect ${provider}` };
  return handler({ ...ctx, access });
};
```

Use in a tool:

```ts
server.registerTool("hubspot.searchContacts", {/*schema*/},
  withOAuth("hubspot", async ({ args, access }) => {
    const res = await fetch(/* HubSpot API */);
    return { results: res };
  })
);
```

*Pros:* typeâ€‘safe, explicit; *Cons:* tiny boilerâ€‘plate per tool.

### 5.7Â Token Refresh Strategy

We rely on **workersâ€‘oauthâ€‘provider** (our internal wrapper) to handle refresh tokens automatically when an API call fails with 401/403â€”`ensureTokenOrAuthUrl()` only supplies the current access token.

---

## 6Â Â· Tool Registration & Adapters (`server.registerTool`)

Â Â· Tool Registration & Adapters (`server.registerTool`)

Cloudflareâ€™s base SDK (and the `remote-mcp-github-oauth` template we forked) now expose the \`\` helper.â€¯Instead of exporting adâ€‘hoc functions, we declare every actionable integration with this API so the Worker automatically surfaces the MCP manifest.

### 6.1â€¯Registry Module

Create \`\` that imports `server` (the singleton MCPServer) and registers all tools during module evaluation.

```ts
// src/tools/index.ts
import { z } from "zod";
import { server } from "../mcpServer";      // exported in src/index.ts
authtool from "../auth/tool-auth";
import { callPandaDoc } from "./pandadoc/client";

// PandaDoc â€“ send document for eâ€‘signature
server.registerTool(
  "pandadoc-send",
  {
    title: "Send PandaDoc for Signature",
    description: "Create & send a PandaDoc using a saved template.",
    inputSchema: {
      templateId: z.string(),
      recipientEmail: z.string().email()
    }
  },
  async ({ templateId, recipientEmail }, ctx) => {
    const token = await ctx.auth.getToken("pandadoc");
    const result = await callPandaDoc(token, templateId, recipientEmail);
    return { content: [{ type: "text", text: JSON.stringify(result) }] };
  }
);
```

Repeat this pattern for **HubSpot**, **Xero**, **NetSuite**, and **Autotask**, adapting `inputSchema` and handler logic.â€¯Handlers receive a rich `ctx` containing:

* `auth` helper for perâ€‘tool credential retrieval/refresh.
* `kv`, `d1`, `r2` bindings for state or cache.
* `request`, `env`, `waitUntil` for Worker primitives.

### 6.2â€¯Benefits

| Â Advantage            | Detail                                                                                 |
| --------------------- | -------------------------------------------------------------------------------------- |
| **Strong typing**     | `zod` schemas give compileâ€‘time & runtime validation, autoâ€‘documented in MCP manifest. |
| **Sideâ€‘effect aware** | Handlers can make external calls, stream data, and push `resource_link`s.              |
| **Hotâ€‘plug toggles**  | We conditionally call `server.registerTool` based on `config.tools.<name>.enabled`.    |
| **Rate limiting**     | Wrap handler with `withRateLimit(id, max, period)` to enforce perâ€‘user/tool quotas.    |

### 6.3â€¯Optional Quota Decorator Example (toolâ€‘level)

> **Note:**Â Securityâ€‘critical rate limiting is enforced **only on the ****\`\`**** OAuth endpoints** (see Â§9).Â This decorator is optional and meant for fairness/backâ€‘pressure on heavy tools, not for attack mitigation.

```ts
import { withRateLimit } from "../middleware/rate-limit";

server.registerTool(
  "hubspot-create-contact",
  {
    title: "Create HubSpot Contact",
    description: "Add a new contact record in HubSpot CRM.",
    inputSchema: {
      email: z.string().email(),
      firstName: z.string(),
      lastName: z.string().optional()
    }
  },
  withRateLimit(60, "1m", async ({ email, firstName, lastName }, ctx) => {
    const token = await ctx.auth.getToken("hubspot");
    const response = await fetch("https://api.hubapi.com/crm/v3/objects/contacts", {
      method: "POST",
      headers: { Authorization: `Bearer ${token}`, "Content-Type": "application/json" },
      body: JSON.stringify({ properties: { email, firstname: firstName, lastname: lastName } })
    });
    const data = await response.json();
    return { content: [{ type: "text", text: JSON.stringify(data) }] };
  })
);
```

> **Note:** This replaces the previous â€œinterfaceÂ Toolâ€ abstractionâ€”the new approach is declarative, concise, and aligns with Cloudflareâ€™s evolution.

## 7Â Â· TestingÂ &Â Sandbox

| Concern             | Recommended Piece                                                           | Why it fits                                                                                                                             |
| ------------------- | --------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------- |
| Worker sandbox      | **Vitest**Â +Â **@cloudflare/vitestâ€‘poolâ€‘workers**                            | Each spec executes inside a real Miniflareâ€‘based Workers runtime with the `Env` object, live bindings, and isolated storage.            |
| RecordÂ &Â replay     | **PollyJS**Â +Â **@pollyjs/adapter-fetch**                                    | Wraps globalÂ `fetch`, captures live HTTP as HAR/JSON cassettes, then reâ€‘plays deterministically across Node, Deno, and the Vitest pool. |
| OAuth during tests  | **mockâ€‘oauth2â€‘server** (perâ€‘suite) or Polly `beforePersist` tokenâ€‘scrubbing | Generates controllable JWTs without external IdP; keeps recordings secretâ€‘free.                                                         |
| Absolute unit tests | Vitestâ€™s native mocking or Polly stub mode                                  | Fast logic tests with no network.                                                                                                       |

### 7.1Â Directory Layout

```text
/tests
â”œâ”€ setup/
â”‚   vitest.setup.ts          # Polly & mockâ€‘oauth bootstrap
â”‚   helpers/
â”‚     mockOAuth.ts
â”œâ”€ unit/                     # Noâ€‘network specs
â”‚   toolâ€‘parsers.spec.ts
â”œâ”€ integration/
â”‚   pandadoc.spec.ts         # RECORD=1 writes to __recordings__
â”œâ”€ __recordings__/           # HAR cassettes (committed)
vitest.config.ts
```

### 7.2Â vitest.config.ts (excerpt)

```ts
import { defineConfig } from "vitest/config";
import workers from "@cloudflare/vitest-pool-workers";

export default defineConfig({
  plugins: [workers()],
  test: {
    environment: "miniflare",
    setupFiles: ["./tests/setup/vitest.setup.ts"],
    poolMatchGlobs: ["tests/**/*.{spec,test}.ts"]
  }
});
```

### 7.3Â vitest.setup.ts

```ts
import { Polly } from "@pollyjs/core";
import FetchAdapter from "@pollyjs/adapter-fetch";
import { beforeAll, afterAll, afterEach } from "vitest";
import { startMockOAuthServer } from "./helpers/mockOAuth";

Polly.register(FetchAdapter);

let polly: Polly;
let oauth: Awaited<ReturnType<typeof startMockOAuthServer>>;

beforeAll(async () => {
  oauth = await startMockOAuthServer();
  process.env.OAUTH_ISSUER = oauth.issuer();
  process.env.OAUTH_AUDIENCE = "asi-mcp";

  polly = new Polly("mcp-tool-calls", {
    adapters: ["fetch"],
    mode: process.env.RECORD ? "record" : "replay",
    recordIfMissing: true,
    persister: "fs",
    persisterOptions: { fs: { recordingsDir: "__recordings__" } }
  });

  // Scrub secrets before saving
  polly.server.any().on("beforePersist", (_, rec) => {
    delete rec.request.headers.authorization;
  });
});

afterEach(() => polly.flush());

afterAll(() => {
  polly.stop();
  oauth.stop();
});
```

### 7.4Â NPMÂ Scripts

```jsonc
{
  "scripts": {
    "test": "vitest",
    "test:record": "RECORD=1 vitest --update",
    "test:ci": "vitest --coverage"
  }
}
```

### 7.5Â CI Flow

1. **Developer** runs `npm run test:record`; new external calls are written to `tests/__recordings__/`.
2. Developer commits cassette diffs (treated as source).
3. **CI** executes `npm run test:ci` offline; Polly replays fixtures.
4. On schema changes, run record again to refresh cassettes.

> This stack is **Cloudflareâ€‘native**, deterministic, and keeps secrets out of VCS while letting us run the Worker in an authentic environment.

---

### 7.6Â Coverage Reporting

Vitestâ€™s **v8 instrumentation** (built on Node/V8â€¯coverage &Â `c8`) gives us firstâ€‘class coverage metrics without Babel. We expose reports both locally and in CI.

#### 7.6.1Â vitest.config.tsÂ snippet

```ts
import { defineConfig } from "vitest/config";
import workers from "@cloudflare/vitest-pool-workers";

export default defineConfig({
  plugins: [workers()],
  test: {
    environment: "miniflare",
    setupFiles: ["./tests/setup/vitest.setup.ts"],
    poolMatchGlobs: ["tests/**/*.{spec,test}.ts"],

    /*  ğŸ“Š Coverage  */
    coverage: {
      provider: "v8",            // native instrumentation via c8
      reporter: ["text", "html", "lcov"],
      all: true,                  // include unâ€‘touched files
      exclude: ["tests/**", "src/tools/**/generated/**"],
      reportsDirectory: "coverage",
      statements: 85,
      branches: 80,
      functions: 85,
      lines: 85                   // fail run if below
    }
  }
});
```

#### 7.6.2Â npmÂ Scripts

```jsonc
{
  "scripts": {
    "coverage": "vitest run --coverage",      // local HTML in ./coverage/index.html
    "test:ci": "vitest --coverage"            // already used in CI
  }
}
```

#### 7.6.3Â CI Integration

```yaml
# .github/workflows/ci.yml (excerpt)
- name: Run tests & coverage
  run: npm run test:ci

- name: Upload coverage artifact (HTML)
  uses: actions/upload-artifact@v4
  with:
    name: coverage-html
    path: coverage

- name: Send coverage to Codecov
  uses: codecov/codecov-action@v4
  with:
    files: ./coverage/lcov.info
    flags: asi-mcp
    fail_ci_if_error: true
```

Set up **GitHub branch protection** to require the Codecov check. A failed threshold blocks the merge.

Local developers open `coverage/index.html` for a colourâ€‘coded tree map; CI surfaces pass/fail.

---

## 8Â Â· Deployment & PR Preview URLsÂ Â· Deployment & PR Preview URLs

Cloudflare will automatically build & deploy a new Worker every time code is pushed, and give us an **ephemeral preview URL for every pullâ€‘request** out of the box.

### 8.1Â Plugâ€‘inâ€‘andâ€‘Play SetupÂ (â‰ˆâ€¯2â€¯min)

1. In the Cloudflare Dashboard choose **WorkersÂ â†’Â Deployments â†’ Connect aÂ repository**.
2. Select the ` repo, grant read access, and pick "Use Wrangler config".\ *Wrangler detects **`\*\* and builds accordingly.\*
3. Cloudflare creates two default targets:

   | Event                                                                                                       | Build target       | Example URL                                          |
   | ----------------------------------------------------------------------------------------------------------- | ------------------ | ---------------------------------------------------- |
   | PushÂ toÂ `main`                                                                                              | **production** env | `https://mcp.asi.co.nz` (or `<account>.workers.dev`) |
   | Pullâ€‘Request (any branch)                                                                                   | **preview** env    | `https://asi-mcp-prâ€‘<PR>.workers.dev`                |
   | The Worker name & subâ€‘domain are autoâ€‘derived from the PR number so we no longer need manual interpolation. |                    |                                                      |
4. Preview deployments are automatically removed when the PR is merged or closedâ€”no teardown script required.
5. Secrets &Â bindings are configured once under **Workers â†’ Settings â†’ Variables &Â Secrets** and are injected into *all* builds (preview &Â prod).

---

## 9Â Â· Security Controls

| Layer                         | Control                                                                                                                                                                                                                    |
| ----------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **Edge (CloudflareÂ network)** | **WAFÂ Rateâ€‘Limiting rules** & Managed Rulesets â€“ block or throttle abusive IPs before they hit the Worker (e.g.Â `100Â req/10â€¯min/IP` on `/auth/*`, credentialâ€‘stuffing & bot heuristics).                                   |
| **Worker**                    | **WorkersÂ Rate LimitingÂ API** for perâ€‘customer or perâ€‘route quotas in code (sliding window backed by the same infra as WAF).â€¢ `/auth/*` â‡’Â `50Â req/min/userId` â€¢ Optional quotas on heavy tools for fairness, not security. |
| **Data**                      | KV/D1 encryption at rest; secrets redacted in logs.                                                                                                                                                                        |
| **Audit**                     | DurableÂ Object `audit_logs` captures auth grants & tool invocations; streamed to R2 for longâ€‘term retention.                                                                                                               |

> **Why both?**Â WAF handles volumetric attacks and IPâ€‘based abuse **outside** the Workerâ€™s execution budget; the RateÂ Limiting API enforces logical quotas (per customer, per API key) **inside** the sandbox. They share Cloudflareâ€™s global counters so limits are consistent.

---

## 11Â Â· Observability â€“ Sentry Monitoring Â Â· Observability â€“ Sentry MonitoringÂ 

### 11.1Â InstrumentingÂ *our* MCP Server

```jsonc
// wrangler.jsonc excerpt
{
  "compatibility_flags": ["nodejs_als"] // enables AsyncLocalStorage
}
```

```ts
// sentry.ts
import * as Sentry from "@sentry/cloudflare";
export const sentryCfg = (env: Env) => ({
  dsn: env.SENTRY_DSN,
  tracesSampleRate: 1.0,      // dial down in prod
});

// src/index.ts â€“ Worker entry
import { sentryCfg } from "./sentry";
import router from "./router";              // Hono / itty router
export default Sentry.withSentry(sentryCfg, router);

// src/mcp.ts â€“ Durable Object that subclasses McpAgent
import { sentryCfg } from "./sentry";
export const MCP = Sentry.instrumentDurableObjectWithSentry(
  sentryCfg,
  class extends McpAgent<Props, Env> { /* â€¦ */ },
);
```

*This matches DavidÂ Cramerâ€™s Julyâ€¯2025 guide; no â€œformal MCP wrapperâ€ is available yet.*

#### 11.1.1Â Toolâ€‘Span Helper

We keep the lightweight helper that wraps each `server.registerTool()` handler so every tool invocation appears as a **child span** (`mcp.tool/<name>`) inside the request trace:

```ts
// observability/tool-span.ts
import * as Sentry from "@sentry/cloudflare";
export function wrapTool<T extends z.ZodTypeAny>(
  name: string,
  handler: (args: z.infer<T>, ctx: ToolContext) => Promise<ToolResponse>
) {
  return async (args: z.infer<T>, ctx: ToolContext): Promise<ToolResponse> =>
    Sentry.startNewTrace(async () =>
      Sentry.startSpan({ name: `mcp.tool/${name}` }, () => handler(args, ctx))
    );
}
```

Use it inside \`\`:

```ts
server.registerTool(
  "xero-create-invoice",
  {/* schema */},
  wrapTool("xero-create-invoice", async (args, ctx) => { /* â€¦ */ })
);
```

### 11.3Â Sourceâ€‘Maps & Logs

```toml
upload_source_maps = true
```

```bash
wrangler secret put SENTRY_DSN
npx @sentry/wizard@latest -i sourcemaps
```

Enable **Sentry Logs (beta)** by adding ` _experiments: { enableLogs: true }` in `sentryCfg` if desired.

### 11.4Â Sampling & Cost Control

```ts
export const sentryCfg = (env: Env) => ({
  dsn: env.SENTRY_DSN,
  tracesSampleRate: env.SENTRY_SAMPLE_RATE ?? 0.1,
});
```

Lower sampling in production or adopt dynamic rules.

### 11.5Â What Shows Up in Sentry

| Signal                       | Where it appears                                              |
| ---------------------------- | ------------------------------------------------------------- |
| Uncaught Worker crashes      | Issue with Cloudflare metadata & release tag                  |
| Toolâ€‘level errors            | Issue linked to `mcp.tool/<id>` span                          |
| Slow/expensive tool calls    | Performance view â†’ root Worker transaction + child tool spans |
| (Optâ€‘in) console.log outputs | Sentry Logs, correlated with the trace ID                     |

---

End of RevisionÂ 0.6
